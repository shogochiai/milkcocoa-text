# 後半

milkcocoa-syncではデータを同期することだけしかできませんでした。なぜなら、入門版として学習コスト無く扱える事だけを追求したバージョンだったからです。
次はmilkcocoa.js本体を用いて、より多彩な表現を行いましょう。

Kinect-jThree連携だけ学べれば良い方は読む必要はあまりないですが、これからの開発の幅を広げる便利な道具なので、ぜひとも読んでいただきたい内容です。

## milkcocoa-syncからmilkcocoaへ

### 何が変わるのか
1.保存/検索機能
　send関数だけでなく、pushやqueryといった関数が使えるようになります。データを保存したり、保存した事をリアルタイム同期したり、保存したデータを検索したりできることによって、ユーザーのデータを蓄積・利用できるようになります。
2.signup/signin機能
　アカウント作成・ログイン機能が使用できるようになります。ユーザーがログインしているか否かの情報をもとに表示するデータを切り分けることで、ユーザーごとに異なるサービスを提供できるようになります。
3.アクセス制限
　IPやログイン情報でデータへのアクセスを制御することで、悪意のある人物がサイト以外の場所からmilkcocoaを操作したり、ブラウザコンソールから無理矢理データにアクセスすることを防ぐことができます。

### 利点
1.簡単さ
開発にかかるコストが減るので、気持ち的に新しいことを始める際の抵抗がかなり少なくなります。
加えて、WEBサービス-アプリ-IoTデバイスの連携なども気軽に試そうという気になります。
相対的に他の人よりも新しい表現に高速に挑戦していけるので、より多くの学びと評価を得られます。

2.柔軟さ
単体ではできることが自前で作るWEBアプリケーションより少ないのは事実です。簡単さの代わりに犠牲にしたものは大きいです。しかし、組み合わせが可能です。NodeJSで利用可能なクライアントライブラリを用いればmilkcocoaのデータをサーバー上で利用したり同期したりできますので、milkcocoaで高速に始めたサービスを後から他の言語で作ったAPIサーバーとの連携してマイクロサービス的な作りにもできます。

### 欠点
1.firebaseとpubnubの管理画面を触る必要がある
　firebaseとpubnubを組み合わせて作られたmilkcocoaのインターフェースですが、保存したデータを一覧で見たりセキュリティを書ける際はfirebaseの管理画面にいかなければなりません。また、milkcocoa-syncの場合は初めからkeyが内包されているのでpubnubの管理画面に行く必要はありませんが、milkcocoaの場合はpubnubのpubkeyとsubkeyを管理画面で取得する必要があります。
2.一定のデータ量を超えるとアップグレードの必要がある
　firebaseとpubnubは無料のWEBアプリケーションを提供してくれます。しかし、サービスのトラフィックが増えると課金が必要になります。保存/検索のトラフィックが増えた場合はfirebaseに、データの同期のトラフィックが増えた場合はpubnubの課金が必要です。フロントエンドの作り方に依存してどちらのトラフィックが増えるかは変わりますのでお気をつけください。しかし開発コストを考えると課金額は割安だと思います。ちなみに、firebaseはGoogleに買収されていますし、pubnubはfirebase以上のデバイス数を日々捌いていますので、安定感は抜群です。
3.セキュリティに気を遣うと多少の学習コストがある
　本番環境でサービスを運営する際には、アプリケーションの種類によてはfirebase/pubnubの管理画面でデータストアに対するセキュリティルールをかけなければならない場合があります。その場合に穴がないようにセキュリティルールや許可オリジンを設定するには、多少のWEBセキュリティについての理解が必要になります。しかし、従来のWEB開発よりも塞ぐべき穴が少ないため、比較的労力は低いです。
4.jsonデータとして常に手動でバックアップをとらないとfirebaseに何かあったときにデータが消失する
　firebaseに保存されたデータは、管理画面からexportすることができます。しかし、これは自動化できないタスクなので、毎日毎時間バックアップを残すのには大変な労力がかかります。Googleを信頼するか、手動でバックアップをとるか、喪失したくないデータは別のDBに保存するかなどの判断が必要になりますので、BaaSを使うべきアプリケーションか否かの判断が必要になるときもあります。

## インターフェース

ここで、milkcocoa完全版が提供する機能についてざっと説明します。

### MilkCocoaオブジェクト

このオブジェクトは、認証とdataStoreオブジェクトへのアクセスを提供します。

`new MilkCocoa()`
データストアへの接続を確立し、通信に使うMilkCocoaオブジェクトのインスタンスを取得します。

`dataStore()`
データの保存や取得の命令を出すため、データストアとの通信を行うDataStoreオブジェクトを取得します。

`addAccount()`
新しいログインアカウントを作成します。

`login()`
ログインの処理を行います。

`logout()`
ログアウトの処理を行います。

`getCurrentUser()`
現在ログインしているユーザの情報を取得します。ユーザーのログイン・非ログインで表示する情報を切り分けるなどして利用します。

### DataStoreオブジェクト
このオブジェクトは、データの保存や取得、そしてリアルタイム同期を提供します。

`push()`
データストアに新しくデータを追加します。

`set()`
データストアの要素を変更します。

`remove()`
データストアからデータを削除します。

`send()`
データストアにデータを残さず、現在接続されているユーザーにデータを送信することができます。

`on()`
データストアへのイベントを登録します。

`off()`
データストアに登録されたイベントを解除します。

`get()`
特定のデータストア要素を取得することができます。

`query()`
データストアからデータをまとめて取得します。

`child()`
子のデータストアを取得するメソッドできます。

`parent()`
親のデータストアを取得するメソッドです。

`root()`
ルートのデータストアを取得するメソッドです。

### Queryオブジェクト
このオブジェクトは、複雑な検索条件でのデータの取得をサポートします。

`done()`
データストアからデータの取得を行います。

`limit()`
取得件数に制限をかけます。

`skip()`
読み飛ばすデータ数を指定します。

`sort()`
指定した要素でデータを降順にソートします。


## milkcocoaの具体的な使い方のパターン
### 一覧画面にはQuery
　サービスやメディアでよくある、大量のデータを一覧で表示するような画面にはdataStore.query()を用います。
　あるデータストアから全件取得したい場合は空のオブジェクト{}を利用します。具体的に書くと、
　
```:index.js

var milkcocoa = new MilkCocoa("firebase_id", "pubnub-pubkey", "pubnub-subkey");

milkcocoa.dataStore("hoge").query({}).done(function(data){
	console.log(data);
});

```

となります。data変数がオブジェクトの配列として得られるので、データをHTMLに埋め込んで一覧画面を作ることとなります。

### データ保存にはpushかset
　dataStoreにデータを保存する際に、pushとsetという方法が選べます。pushはユニークでランダムなidを生成してJSONを保存します。setは任意のidを開発者が指定できます。基本的にpushで事足りますが、初めに生成したデータを2回目以降使い回したいときなどにsetが便利なケースも多々あります。

### 変更をリアルタイム同期したいならon
　データの追加や削除を検知して、それをきっかけに不特定多数のユーザーのUIに影響を与えるようなことがしたいのなら、on関数があなたを強力にサポートしてくれます。
　on関数は、サーバーサイドのイベント駆動プログラミングのようなもので、データストアを監視することができます。これによって、複数のデバイスやユーザーでイベントを共有しているような体験を簡単に演出できます。

### イベント同期したいならsend-onsendペア
　pushやremoveのようにデータの変更を伴ったイベントを監視するだけでなく、データストア自体には何の影響も与えずにイベントだけを同期することもできます。それがsend関数と、on("send", cb)関数です。
　この関数の利点は気軽さにあります。データを蓄積しないので、いくらsend関数を実行しようがデータ容量を圧迫しません。何気ないユーザーのインタラクションを共有するのに非常に適しています。

### loginありサービスなら、getCurrentUserで表示を切り分け
　milkcocoaに用意されたaddAccount, login, logout, getCurrentUser関数は、簡単に認証システムを実現することを可能にします。
　現在はemail認証だけしか提供していませんが、開発の進捗に依存してTwitterOAuth（ソーシャルログイン）なども、バックエンドの開発なしに利用できるようになります。
　getCurrentUser関数のコールバック引数が、ログイン/非ログインに依存して変わるので、表示するUIの切り分けが可能になります。また、セキュリティルールでもログインしているか否かによってデータ入出力を制御する機能があります。フロントエンドでもバックエンドでも制御が可能なので、上手に利用しましょう。

```:user.js

milkcocoa.getCurrentUser(function(err, user){
	var isLoggedIn = (err == null);
	if(isLoggedIn){
		renderLoggedInContents(user);
	} else {
		returnToIndex();
	}
});


```


### membersデータストアで管理者権限を実現する
　例えば、milkcocoaで何かアカウント機能つきサービスを開発した際に、限られた数名にしか見せたくないコンテンツがあったとします。そのときは、membersデータストアを作りましょう。（名前は何でも良いですよ）
　どういうことかというと、membersデータストアに登録されていない名前(あるいはid等)がコンテンツにアクセスしようとしたときに、アクセスを弾くようなコードが実装できるからです。
　これによって管理者権限のようなものが実装できます。 
　
```:user.js

milkcocoa.getCurrentUser(funciton(err, user){
	ds_members.query({member_id:user.id}).done(function(err, target){
		if(target) renderPremiumContent(target);
		else back();	
	});
});


```

## milkcocoa(および他のBaaS各社)が動く環境
### ブラウザ
もっともポピュラーな利用法です。JavaScriptを用いてWEBサービスだったり、インタラクティブなコンテンツを作ります。アプリやIoTと連携したサービスの管理画面として使われることも多いです。

### iOS/Android
初めはサーバーサイドのことなんて考えないで、気ままにアプリを開発する際などに使います。
send関数を用いてブラウザとのデータ同期をしてみたり、位置情報を送ったり、様々なインタラクションをイメージした側から試せます。

### サーバー(NodeJS)
かなりエンジニア向けになりますが、NodeJSのExpress等と連携して利用することもできます。フロントエンドやアプリ側でユーザーが保存したデータを、サーバー側で同期したり取り出してみて、NodeJS側のライブラリ等で解析して保存し直したり、ブラウザだけに任せると大変な処理を分散させたり、様々な利用法が可能と成ります。既存システムとの連携で同期処理の工数を削減もできます。

### IoTデバイス
リアルタイム通信を実装する苦労がないので、メカデザインやサービスデザインに集中できます。また、アプリやブラウザや他のIoTデバイスとの連携も自由に構想できます。WEB系の技術だけでセンサープログラミングをして、データをサーバーに飛ばして解析して、それをアプリで閲覧ような複雑な連携もイメージしやすいです。